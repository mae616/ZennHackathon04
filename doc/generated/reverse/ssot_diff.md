# SSOT差分提案

## このドキュメントについて

コード解析の結果、SSOT（`doc/input/rdd.md`, `doc/input/architecture.md`）との差分を検出した場合に記録します。

**更新日時**: 2026-02-02

---

## 検出された差分

### 1. Next.jsバージョン表記の不整合

| 項目 | SSOT (rdd.md) | CLAUDE.md | 実際のpackage.json |
|------|--------------|-----------|-------------------|
| Next.js | 16 | 16 | **16.1.6** |

**検証結果**: `apps/web/package.json` で `"next": "16.1.6"` を確認。

**対応**: RDD・CLAUDE.md・リバースドキュメントすべてを Next.js 16 に統一

**ステータス**: ✅ 解決済み（2026-02-02）

---

### 2. Content Script マッチパターンの不整合

| 項目 | CLAUDE.md (旧) | 実際のコード |
|------|---------------|-------------|
| Gemini | `*://*.google.com/*` | `*://gemini.google.com/*` |

**提案**: CLAUDE.md のマッチパターンを実際のコードに合わせて修正済み

**ステータス**: ✅ 解決済み（2026-02-02）

---

## 今後の検討事項

### A. 認証機能の追加（RDD記載）

- **RDD記載**: 「Firebase Auth想定（後日）」
- **現状**: 認証未実装（MVP段階）
- **提案**: Sprint 2以降で Firebase Auth を追加
- **マイグレーション計画（認証追加時）**:
  1. 既存データのオーナーシップ割り当て（単一ユーザー→userId付与）
  2. APIバージョニング検討（`/api/v1/` vs ヘッダーベース）
  3. 拡張機能の認証フロー追加（OAuth or トークン連携）

### B. テスト戦略の実装（RDD記載）

- **RDD記載**: 「テスト戦略: Vitest（後日追加）」
- **現状**: テストファイルなし
- **提案**: Sprint 2以降で Vitest を導入

### C. 観測性の実装（RDD記載）

- **RDD記載**: 「観測性: Cloud Logging（後日）」
- **現状**: `console.log` / `console.error` のみ
- **提案**: Cloud Run デプロイ時に Cloud Logging を統合

### D. データ取得時のバリデーション強化（コード内TODOより）

- **現状**: `apps/web/src/app/api/conversations/route.ts:130-131` にコメントあり
  - 「Firestoreのデータは保存時にZodで検証済みのため、型アサーションを使用」
  - 「将来的にはConversationSchema.parseで再検証することで堅牢性を向上できる」
- **優先度**: 低（保存時にバリデーション済みのため、即座のリスクは低い）
- **提案**: データマイグレーション/スキーマ変更時に併せて実装

---

## 変更要求が必要な場合のテンプレート

```
Change Request: {タイトル}
- RDD参照: doc/input/rdd.md §{該当セクション}
- 現状の制約: {なぜRDD準拠だと難しいか}
- 提案差分: {スタック/設計の変更内容（最小）}
- 影響: {テスト/運用/セキュリティ/コスト}
- 代替案: {検討したが採用しない案}
- 戻し方: {ロールバック手順}
- 推奨: 承認/却下の判断材料
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-02 | 初回作成、マッチパターン不整合を解決 |
| 2026-02-02 | Next.jsバージョン再検証（実際は16.1.6）、全ドキュメント統一完了 |
| 2026-02-02 | 認証マイグレーション計画、データバリデーション優先度を追記 |
